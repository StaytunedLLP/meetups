# 3. Block Catalog & Placement Guide**

## 3.1. Introduction to the Block System

Blocks (`bk_*`) are the fundamental building units. Their **placement is
strictly defined** based on their scope and purpose. Referencing the correct
shared block or placing story-specific blocks correctly is crucial for
maintainability.

## 3.2. **The Definitive Block Placement Guide Table**

**(MANDATORY REFERENCE - Do not deviate without explicit architectural
approval)**

| No. | Block Name                       | **Allowed Locations**                                                          | Purpose                                     | Typical Files                                       | Notes / Key Interactions                                                                |
| --- | -------------------------------- | ------------------------------------------------------------------------------ | ------------------------------------------- | --------------------------------------------------- | --------------------------------------------------------------------------------------- |
| 1   | `bk_analytics`                   | `fd_*/_shared`, `fe_*/_shared`, `sy_*/`                                        | Analytics implementations                   | `analytics.service.ts`, `analytics.types.ts`        | Often integrates with `bk_otel_metrics` or external services.                           |
| 2   | `bk_api`                         | **`sy_*/`** (primary), `fe_*/_shared` (rarely, for shared service logic)       | **Core Business Logic Services**            | `services/*.service.ts`, `*.api.types.ts`           | Called ONLY by GraphQL Resolvers (or REST controllers if used). Orchestrates logic.     |
| 3   | `bk_assets`                      | `fd_*/static`, `fe_*/_shared`                                                  | Static assets (images, fonts, global CSS)   | `images/`, `styles/`, `fonts/`                      | Served directly by Fresh.                                                               |
| 4   | `bk_auth`                        | `src/_shared`, `fd_*/_shared` (if domain-specific auth)                        | Authentication & Authorization              | `auth.service.ts`, `auth.middleware.ts`             | Centralized auth logic. Used by middleware, services.                                   |
| 5   | `bk_cache_client`                | `fd_*/_shared`                                                                 | Client-side caching (UI state)              | `cache.service.ts`, `cache.hooks.ts`                | Often uses localStorage/sessionStorage or in-memory stores.                             |
| 6   | `bk_cache_server`                | `fd_*/_shared`                                                                 | Server-side caching (data, computations)    | `cache.service.ts`                                  | Typically uses Deno KV via `bk_data_access_kv`.                                         |
| 7   | `bk_constants`                   | `src/_shared`, `fd_*/_shared`, `fe_*/_shared`                                  | Shared constants, enums                     | `*.constants.ts`, `*.enums.ts`                      | Typed constants for reuse.                                                              |
| 8   | `bk_config`                      | `src/_shared` (primarily), `fd_*/_shared` (if domain-specific)                 | Typed Environment Variable Access           | `config.service.ts`, `config.types.ts`              | **ONLY** reads `Deno.env`. Includes validation logic run at startup.                    |
| 9   | `bk_cqrs`                        | **`sy_*/`**                                                                    | CQRS Commands/Queries (Frontend Invocation) | `*.command.ts`, `*.query.ts`, `*.handler.ts`        | Frontend's way to interact with backend logic (alternative to direct GQL hooks).        |
| 10  | `bk_data_access`                 | **`src/_shared`** (preferred), `fd_*/_shared` (if domain-isolated data models) | Data Access Layer Abstraction Root          | (Contains sub-blocks)                               | Top-level container for data access logic.                                              |
| 11  | `bk_data_access_entities`        | Within `bk_data_access/` at `_shared` levels                                   | Data Entity Type Definitions                | `*.entity.ts`, `*.types.ts`                         | Defines core data structures persisted in KV.                                           |
| 12  | `bk_data_access_kv`              | **`src/_shared/bk_data_access` ONLY**                                          | Low-level Deno KV Client Wrapper            | `kv_client.ts`, `kv_schema.ts`, `kv_utils.ts`       | **STRICT:** The ONLY block allowed to directly import/use Deno KV APIs.                 |
| 13  | `bk_data_access_providers`       | Within `bk_data_access/` at `_shared` levels                                   | Repository/Provider Implementations         | `*.provider.ts`, `*.types.ts`                       | Implements interfaces using `bk_data_access_kv`. Consumed by `bk_api`/`bk_graphql`.     |
| 14  | `bk_docs`                        | Any level (`src/_shared`, `fd_*`, `fe_*`, `sy_*`)                              | Developer/Architecture Documentation        | `*.md`, `*.drawio`, etc.                            | Contains guides, diagrams, decisions.                                                   |
| 15  | `bk_error_handling`              | `fe_*/_shared`, `sy_*/`                                                        | Error Handling Utilities/Types              | `errors.ts`, `result.ts`, `error_handler.ts`        | Defines custom Error types or Result types for FP error handling.                       |
| 16  | `bk_feature_flags`               | `src/_shared`, `fd_*/_shared`                                                  | Feature Flag Service/Integration            | `feature_flag.service.ts`, `useFeatureFlag.hook.ts` | Interfaces with Flagger (via its `bk_api` if needed) or other flag providers.           |
| 17  | `bk_gh_issues`                   | **`sy_*/`**, `fe_*/_shared`                                                    | GitHub Issue Markdown Documentation         | `[issue_number]_[type]_[title].issue.md`            | Stores context/requirements linked to code. Future issues go in `_shared/bk_gh_issues`. |
| 18  | `bk_graphql`                     | **`fe_*/_shared`** (Schema), `sy_*/` (Resolvers, Types)                        | GraphQL API Layer                           | `schema.graphql`, `*.resolver.ts`, `*.types.ts`     | Resolvers MUST delegate to `bk_api` services.                                           |
| 19  | `bk_hooks`                       | `fd_*/_shared`, `fe_*/_shared`, `sy_*/`                                        | Custom Reusable Preact Hooks                | `use_*.ts`, `*.hook.ts`                             | For shared UI logic, state derivation, effects.                                         |
| 20  | `bk_i18n`                        | `src/_shared`, `fd_*/_shared`                                                  | Internationalization                        | `i18n.service.ts`, `translations/`                  | Provides translation functions/data.                                                    |
| 21  | `bk_integration_tests`           | Inside `sy_*`, `fe_*`, `fd_*`                                                  | Integration Tests                           | `*.integration.test.ts`                             | Tests interaction between multiple blocks within the scope.                             |
| 22  | `bk_middleware`                  | `src/_shared`, `fd_*/_shared`, `fe_*/_shared`                                  | Fresh Middleware                            | `*.middleware.ts`                                   | For cross-cutting request handling (auth, logging, etc.).                               |
| 23  | `bk_notifications`               | `fd_*/_shared`, `fe_*/_shared`                                                 | User Notification System                    | `notification.service.ts`                           | Handles sending emails, push notifications, etc.                                        |
| 24  | `bk_otel`                        | **`src/_shared`** (Core Config), sub-blocks shared appropriately               | OpenTelemetry Core Config & Sub-modules     | `otel.config.ts`, contains `_logs`, `_metrics`...   | Central OTEL setup.                                                                     |
| 25  | `bk_otel_logs`                   | Shared via `bk_otel`                                                           | OTEL Logging Implementation                 | `otel_logs.service.ts`                              | Provides structured logging functions.                                                  |
| 26  | `bk_otel_metrics`                | Shared via `bk_otel`                                                           | OTEL Metrics Implementation                 | `otel_metrics.service.ts`                           | Provides functions for recording metrics.                                               |
| 27  | `bk_otel_tracer`                 | Shared via `bk_otel`                                                           | OTEL Tracing Implementation                 | `otel_tracer.service.ts`                            | Provides functions for creating spans.                                                  |
| 28  | `bk_queue`                       | `src/_shared`, `fd_*/_shared`, `fe_*/_shared`, `sy_*/`                         | Background Job Queue                        | `*.queue.ts`, `*.job_handler.ts`                    | For handling asynchronous tasks.                                                        |
| 29  | `bk_rate_limiting`               | `fd_*/_shared`                                                                 | Rate Limiting                               | `rate_limiter.service.ts`, `*.middleware.ts`        | Often implemented as middleware.                                                        |
| 30  | `bk_security_audit`              | `_shared` levels                                                               | Security Auditing Logic                     | `security_audit.service.ts`                         | Tools/logic for security checks (can be broad).                                         |
| 31  | `bk_state_management`            | `fd_*/_shared`, `fe_*/_shared`, `sy_*/`                                        | UI State (Primarily Preact Signals)         | `*.signal.ts`, `*.context.ts`                       | Manages shared or complex UI state.                                                     |
| 32  | `bk_ui`                          | **`sy_*/`** (Story specific), **`fe_*/_shared`** (Feature specific reusable)   | UI Components & Presentation Logic          | `*.tsx`, `*.module.css`                             | Components directly implementing story/feature UI.                                      |
| 33  | `bk_ui_components`               | **`fe_*/_shared/bk_ui`**, **`fd_*/_shared/bk_ui`**, **`src/_shared/bk_ui`**    | Foundational, Reusable UI Elements          | `Button.tsx`, `Modal.tsx`, `Input.tsx`              | More generic UI building blocks (like a design system).                                 |
| 34  | `bk_utils`                       | `src/_shared`, `fd_*/_shared`, `fe_*/_shared`                                  | Utility Functions                           | `*.utils.ts`, `*.helpers.ts`                        | Pure, reusable helper functions.                                                        |
| 35  | `bk_validators`                  | `fe_*/_shared`, `sy_*/`                                                        | Input Validation Logic & Schemas            | `*.validator.ts`, `*.schema.ts`                     | Used by services, API layers, potentially frontend.                                     |
| 36  | `bk_web_workers`                 | `_shared` levels, `sy_*/`                                                      | Web Worker Implementations                  | `*.worker.ts`                                       | For offloading heavy client-side tasks.                                                 |
| --  | `routes/`, `islands/`, `static/` | **`fd_*/` ONLY**                                                               | Fresh Framework Core Directories            | `_app.tsx`, `index.tsx`, `MyIsland.tsx`             | MUST reside directly within a domain folder.                                            |
